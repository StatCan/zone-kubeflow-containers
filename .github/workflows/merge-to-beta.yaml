name: Merge to Beta
on:
  schedule:
    - cron: "0 2 * * 3" # Every wednesday
  workflow_dispatch:

jobs:
  get-auto-merge-beta-prs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
    - uses: actions/checkout@v4

    - name: "Merge ready for beta PRs"
      run: |
        # Get list of PR numbers with label "read for beta"
        # pr_list format is "1 24 43 11"
        pr_list=$(gh pr list -l "ready for beta" --json number --jq "[.[].number] | @sh")

        for i in $pr_list
        do
            # for each PR, get their relevant info
            prInfo=$(gh pr view $i --json baseRefName,mergeStateStatus,isDraft,mergeable,title,reviewDecision)
            targetBranch=$(echo $prInfo | jq ".baseRefName")
            mergeState=$(echo $prInfo | jq ".mergeStateStatus")
            isDraft=$(echo $prInfo | jq ".isDraft")
            isMergeable=$(echo $prInfo | jq ".mergeable")
            title=$(echo $prInfo | jq ".title")
            review=$(echo $prInfo | jq ".reviewDecision")

            # if PR matches all our conditions, merge it
            if [[ "$targetBranch" == '"beta-clone-for-testing"'
                && "$mergeState" == '"CLEAN"'
                && $isDraft == false
                && $isMergeable == '"MERGEABLE"'
                && $review == '"APPROVED"' ]]; then
                
                echo "MERGING PR #$i"
                gh pr merge $i --delete-branch --squash
            else
                echo "Not merging PR #$i - $title"
                echo ""
                echo "Target branch should be "beta": is $targetBranch"
                echo "Merge state should be "CLEAN": is $mergeState"
                echo "Should not be in draft. Is draft: $isDraft"
                echo "Should be mergeable. Is mergeable: $isMergeable"
                echo "Should be reviewed. Review is: $review"
            fi
            echo "----------------------------"
        done