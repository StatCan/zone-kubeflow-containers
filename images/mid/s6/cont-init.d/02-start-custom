#!/command/with-contenv bash

echo "--------------------Starting up--------------------"

# -------------------- S6 Overlay Environment --------------------
S6_ENV="/run/s6-env"
mkdir -p "${S6_ENV}"

# -------------------- RStudio / Jupyter Proxy --------------------
export RSERVER_WWW_ROOT_PATH="${NB_PREFIX}/rstudio"
echo "${RSERVER_WWW_ROOT_PATH}" > "${S6_ENV}/RSERVER_WWW_ROOT_PATH"

export NB_NAMESPACE=$(echo "$NB_PREFIX" | awk -F '/' '{print $3}')
echo "${NB_NAMESPACE}" > "${S6_ENV}/NB_NAMESPACE"

# JWT token
export JWT="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
echo "${JWT}" > "${S6_ENV}/JWT"

# -------------------- R Environment --------------------
RENVCFG="/opt/conda/lib/R/etc/Renviron"

# Append environment variables to R environment
{
  echo "NB_PREFIX=${NB_PREFIX}"
  echo "NB_NAMESPACE=${NB_NAMESPACE}"
  echo "NLS_LANG=${NLS_LANG}"
  printenv | grep KUBERNETES
  echo "SPARK_HOME=${SPARK_HOME}"
  printenv | grep svm
} >> "${RENVCFG}"

# -------------------- Conda Channels --------------------
serviceaccountname=$(kubectl get secret artifactory-creds -n "$NB_NAMESPACE" --template={{.data.Username}} | base64 --decode)
serviceaccounttoken=$(kubectl get secret artifactory-creds -n "$NB_NAMESPACE" --template={{.data.Token}} | base64 --decode)

conda config --add channels "https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-forge-remote/"
conda config --add channels "https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-pytorch-remote/"
conda config --add channels "https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-nvidia-remote/"
conda config --remove channels 'defaults'
conda config --remove channels conda-forge --system

pip config set global.index-url "https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/api/pypi/pypi/simple"

# -------------------- Pixi Config --------------------
PIXICONF="/home/${NB_USER}/.pixi/config.toml"
if [ ! -f "$PIXICONF" ]; then
  mkdir -p "$(dirname "$PIXICONF")"
  cat > "$PIXICONF" <<EOF
default-channels = ["https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-forge-remote/"]
EOF
fi

# -------------------- Rprofile.site (future-proof) --------------------
RPROFILE="/opt/conda/lib/R/etc/Rprofile.site"
if [ ! -f "$RPROFILE" ]; then
  cat > "$RPROFILE" <<'EOF'
# --- Ensure user library exists ---
dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)

# --- Set repos dynamically based on R version ---
rver <- paste0(R.Version()$major, ".", R.Version()$minor)
serviceaccountname <- Sys.getenv("ARTIFACTORY_USER")
serviceaccounttoken <- Sys.getenv("ARTIFACTORY_TOKEN")
options(
  repos = list(
    "ppm" = paste0("https://", serviceaccountname, ":", serviceaccounttoken, "@artifactory.cloud.statcan.ca/artifactory/zone-r-ppm-bin-noble-", rver, "-remote")

  )
)

# --- Migration helper (optional) ---
migrate_old_packages <- function() {
  old_lib <- "~/R/r-packages-4.4.1"
  new_lib <- Sys.getenv("R_LIBS_USER")
  if (!file.exists("~/.migration_done") && dir.exists(old_lib)) {
    pkgs <- list.files(old_lib)
    if (length(pkgs) > 0) {
      message("Migrating ", length(pkgs), " packages from old R library to current library...")
      install.packages(pkgs, lib=new_lib, repos=getOption("repos"))
    }
    file.create("~/.migration_done")
    message("Migration complete.")
  } else {
    message("No migration needed or already done.")
  }
}
EOF
fi

# -------------------- Language Configuration --------------------
if [ -n "${KF_LANG}" ]; then
    if [ "${KF_LANG}" = "en" ]; then
        export LANG="en_US.utf8"
    else
        export LANG="fr_FR.utf8"
        
        # JupyterLab language settings
        lang_file="/home/${NB_USER}/.jupyter/lab/user-settings/@jupyterlab/translation-extension/plugin.jupyterlab-settings"
        if [ ! -e "${lang_file}" ]; then
            mkdir -p "$(dirname "${lang_file}")"
            cat > "${lang_file}" << EOF
{
    "locale": "${LANG}"
}
EOF
        fi

        # VS Code language settings
        vscode_language="/home/${NB_USER}/.vscode/User/argv.json"
        if [ ! -e "${vscode_language}" ]; then
            mkdir -p "$(dirname "${vscode_language}")"
            echo "{\"locale\":\"fr\"}" > "${vscode_language}"
        fi
    fi
    echo "${LANG}" > "${S6_ENV}/LANG"
fi

echo "Language configuration complete"

echo "--------------------Startup complete--------------------"
