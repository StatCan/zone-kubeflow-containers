#!/command/with-contenv bash

echo "--------------------Starting up--------------------"

# create directory to store env vars for s6-overlay
S6_ENV="/run/s6-env"
[ -d "${S6_ENV}" ] || mkdir -p "${S6_ENV}"

# Introduced by RStudio 1.4
# See https://github.com/jupyterhub/jupyter-rsession-proxy/issues/95
# And https://github.com/blairdrummond/jupyter-rsession-proxy/blob/master/jupyter_rsession_proxy/__init__.py
export RSERVER_WWW_ROOT_PATH=$NB_PREFIX/rstudio
echo ${RSERVER_WWW_ROOT_PATH} > ${S6_ENV}/RSERVER_WWW_ROOT_PATH

export NB_NAMESPACE=$(echo $NB_PREFIX | awk -F '/' '{print $3}')
echo ${NB_NAMESPACE} > ${S6_ENV}/NB_NAMESPACE

export JWT="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
echo ${JWT} > ${S6_ENV}/JWT

# Setup environment variables for R and Rstudio
echo "NB_PREFIX=${NB_PREFIX}" >> /opt/conda/lib/R/etc/Renviron
echo "NB_NAMESPACE=$NB_NAMESPACE" >> /opt/conda/lib/R/etc/Renviron
echo "NLS_LANG=$NLS_LANG" >> /opt/conda/lib/R/etc/Renviron
printenv | grep KUBERNETES >> /opt/conda/lib/R/etc/Renviron
echo "SPARK_HOME=${SPARK_HOME}" >> /opt/conda/lib/R/etc/Renviron
# Filer related env vars for R & Rstudio
printenv | grep svm >> /opt/conda/lib/R/etc/Renviron

# Retrieve service account details
serviceaccountname=`kubectl get secret artifactory-creds -n $NB_NAMESPACE --template={{.data.Username}} | base64 --decode`
serviceaccounttoken=`kubectl get secret artifactory-creds -n $NB_NAMESPACE --template={{.data.Token}} | base64 --decode`
# Point conda to Artifactory repository
conda config --add channels https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-forge-remote/
conda config --add channels https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-pytorch-remote/
conda config --add channels https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-nvidia-remote/
conda config --remove channels 'defaults'
conda config --remove channels conda-forge --system

pip config set global.index-url https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/api/pypi/pypi/simple

# create pixi config to change default channel
if [ ! -d "/home/${NB_USER}/.pixi/config.toml" ]; then
  echo "Creating pixi config"
  cat > /home/${NB_USER}/.pixi/config.toml << EOF
default-channels = ["https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/conda-forge-remote/"]
EOF
fi

# if rprofile doesnt exist
if [ ! -d "/opt/conda/lib/R/etc/Rprofile.site" ]; then
  echo "Creating rprofile"
  cat > /opt/conda/lib/R/etc/Rprofile.site<< EOF
options(jupyter.plot_mimetypes = c('text/plain', 'image/png', 'image/jpeg', 'image/svg+xml', 'application/pdf'))

local(
  options(
    repos = list(
      "ppm" = "https://$serviceaccountname:$serviceaccounttoken@artifactory.cloud.statcan.ca/artifactory/zone-r-ppm-bin-noble-4.5-remote"
    )
  )
)
EOF
fi

# Configure the language
if [ -n "${KF_LANG}" ]; then
    if [ "${KF_LANG}" = "en" ]; then
        export LANG="en_US.utf8"
        echo ${LANG} > ${S6_ENV}/LANG
    else
        export LANG="fr_FR"
        echo ${LANG} > ${S6_ENV}/LANG

        lang_file="/home/${NB_USER}/.jupyter/lab/user-settings/@jupyterlab/translation-extension/plugin.jupyterlab-settings"
        if [ ! -e ${lang_file} ]; then
          mkdir -p "$(dirname "${lang_file}")" && touch $lang_file
          ( echo    '{'
            echo     '   // Langue'
            echo     '   // @jupyterlab/translation-extension:plugin'
            echo     '   // Paramètres de langue.'
            echo  -e '   // ****************************************\n'
            echo     '   // Langue locale'
            echo     '   // Définit la langue d'\''affichage de l'\''interface. Exemples: '\''es_CO'\'', '\''fr'\''.'
            echo     '   "locale": "'${LANG}'"'
            echo     '}'
          ) > $lang_file
        fi

        vscode_language="${CS_DEFAULT_HOME}/User/argv.json"
        if [ ! -e ${vscode_language} ]; then
          echo "{\"locale\":\"fr\"}" >> $vscode_language
        fi
    fi
fi

echo "language has been configured"

# move sascfg config

mkdir /home/${NB_USER}/.config/saspy
mv /opt/conda/lib/python3.13/site-packages/saspy/sascfg.py ~/.config/saspy/saspycfg_personal.py